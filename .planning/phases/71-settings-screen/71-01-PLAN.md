---
phase: 71-settings-screen
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DuplicatePhotos/Views/SettingsView.swift
  - DuplicatePhotos/Views/ContentView.swift
  - DuplicatePhotos/Models/ScanSettings.swift
autonomous: true

must_haves:
  truths:
    - "User can access settings from main screen via gear icon"
    - "User can adjust similarity threshold with slider"
    - "User sees current threshold as percentage"
    - "User can clear embedding cache"
    - "User can see cached photo count"
    - "User can reset threshold to default"
    - "Threshold persists between app launches"
    - "Scan uses user-selected threshold"
  artifacts:
    - path: "DuplicatePhotos/Views/SettingsView.swift"
      provides: "Complete settings UI with all sections"
      min_lines: 100
    - path: "DuplicatePhotos/Views/ContentView.swift"
      provides: "Toolbar with gear icon navigation"
      contains: "ToolbarItem"
    - path: "DuplicatePhotos/Models/ScanSettings.swift"
      provides: "UserDefaults-backed threshold"
      contains: "UserDefaults"
  key_links:
    - from: "DuplicatePhotos/Views/ContentView.swift"
      to: "DuplicatePhotos/Views/SettingsView.swift"
      via: "NavigationLink in toolbar"
      pattern: "NavigationLink.*SettingsView"
    - from: "DuplicatePhotos/Views/SettingsView.swift"
      to: "@AppStorage"
      via: "property wrapper binding"
      pattern: "@AppStorage.*similarityThreshold"
    - from: "DuplicatePhotos/Models/ScanSettings.swift"
      to: "UserDefaults"
      via: "reads persisted threshold"
      pattern: "UserDefaults.standard.double"
---

<objective>
Create settings screen with similarity threshold slider, cache management, and about section.

Purpose: Let users fine-tune duplicate detection sensitivity and manage app data.
Output: Working SettingsView accessible from main screen with persisted settings.
</objective>

<execution_context>
@/Users/Moshe.Avni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Moshe.Avni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/71-settings-screen/71-CONTEXT.md
@.planning/phases/71-settings-screen/71-RESEARCH.md
@DuplicatePhotos/Views/ContentView.swift
@DuplicatePhotos/Models/ScanSettings.swift
@DuplicatePhotos/Services/CacheService.swift
@DuplicatePhotos/ViewModels/ScanViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsView with all sections</name>
  <files>DuplicatePhotos/Views/SettingsView.swift</files>
  <action>
Create a new SwiftUI view `SettingsView.swift` in the Views folder with:

1. **Similarity Threshold Section:**
   - Use `@AppStorage("similarityThreshold")` with default 0.92
   - Slider with range 0.85...0.98, step 0.01
   - Display percentage above slider: `Text("\(Int(threshold * 100))%")`
   - Explanatory caption: "Higher = stricter matching, fewer results"

2. **Cache Management Section:**
   - `@State private var cachedCount: Int = 0`
   - `LabeledContent` showing "Cached Photos" with count
   - "Clear Cache" button with `role: .destructive`
   - `.confirmationDialog()` before clearing
   - Success toast after clearing (simple opacity animation overlay)
   - Load cache stats in `.task` modifier using `CacheService().getCacheStats()`

3. **About Section:**
   - `LabeledContent` for Version (from `Bundle.main.infoDictionary["CFBundleShortVersionString"]`)
   - `LabeledContent` for Build (from `Bundle.main.infoDictionary["CFBundleVersion"]`)
   - `LabeledContent` for Credits showing "Built with CoreML"

4. **Reset Section:**
   - Button "Reset to Defaults" that sets threshold back to 0.92

Use `Form` container with `Section` groups. Set `.navigationTitle("Settings")` and `.navigationBarTitleDisplayMode(.inline)`.

Reference pattern from RESEARCH.md for complete implementation.
  </action>
  <verify>
Build succeeds: `xcodebuild -project DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`
  </verify>
  <done>SettingsView.swift exists with Form containing threshold slider, cache section, about section, and reset button</done>
</task>

<task type="auto">
  <name>Task 2: Add gear icon navigation to ContentView</name>
  <files>DuplicatePhotos/Views/ContentView.swift</files>
  <action>
Modify ContentView to add settings navigation:

1. Add `.toolbar` modifier to the existing VStack (inside NavigationStack, after `.padding()`):
```swift
.toolbar {
    ToolbarItem(placement: .topBarTrailing) {
        NavigationLink(destination: SettingsView()) {
            Image(systemName: "gear")
        }
    }
}
```

The gear icon should only appear on the main ContentView, not on ScanView or results screens. The existing code structure already handles this since toolbar is on the root VStack.
  </action>
  <verify>
Build succeeds and gear icon visible: Run app in simulator, verify gear appears in top-right corner of home screen.
  </verify>
  <done>ContentView has toolbar with gear icon that navigates to SettingsView</done>
</task>

<task type="auto">
  <name>Task 3: Update ScanSettings to read from UserDefaults</name>
  <files>DuplicatePhotos/Models/ScanSettings.swift</files>
  <action>
Modify ScanSettings.swift to read threshold from UserDefaults:

1. Change `similarityThreshold` from stored property to computed property:
```swift
var similarityThreshold: Float {
    let stored = UserDefaults.standard.double(forKey: "similarityThreshold")
    // Return default if not set (0.0 means unset)
    return stored > 0 ? Float(stored) : 0.92
}
```

2. Keep other properties (`batchSize`, `useCaching`, `includeVideos`) as stored properties with defaults.

3. Keep `static let default = ScanSettings()` pattern - it will now pick up UserDefaults value.

This ensures ScanViewModel and DuplicateDetector use the user's selected threshold without code changes. The @AppStorage in SettingsView writes to the same "similarityThreshold" key that ScanSettings reads.
  </action>
  <verify>
Build succeeds. Test: Open settings, change threshold, run scan - verify DuplicateDetector receives the new threshold value.
  </verify>
  <done>ScanSettings.similarityThreshold reads from UserDefaults, falling back to 0.92 default</done>
</task>

</tasks>

<verification>
1. Build project with no errors
2. Launch app in simulator:
   - Main screen shows gear icon in top-right
   - Tap gear navigates to Settings
   - Settings shows threshold slider with current percentage
   - Slider adjusts between 85-98%
   - Cache section shows count and Clear button
   - About section shows version info
   - Reset button works
3. Close and reopen app - threshold persists
4. Run scan - uses selected threshold
</verification>

<success_criteria>
- Settings view accessible from main screen via gear icon
- Slider adjusts threshold between 85-98%, shows percentage
- Threshold persists in UserDefaults across app launches
- Cache clear works with confirmation dialog
- About section displays version and build number
- Reset to defaults restores 0.92 threshold
- Scan uses user-selected threshold (verified in logs)
</success_criteria>

<output>
After completion, create `.planning/phases/71-settings-screen/71-01-SUMMARY.md`
</output>
