---
phase: 71-settings-screen
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DuplicatePhotos/Views/ContentView.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "First click on Start Scan triggers actual scan"
    - "User sees scan progress immediately after clicking Start Scan"
    - "No second click required to start scanning"
  artifacts:
    - path: "DuplicatePhotos/Views/ContentView.swift"
      provides: "ScanView with auto-start on appear"
      contains: ".task"
  key_links:
    - from: "ScanView"
      to: "viewModel.startScan()"
      via: ".task modifier on view appear"
      pattern: "\\.task.*await.*startScan"
---

<objective>
Fix UX bug where first click on "Start Scan" shows cached empty state instead of actually starting the scan.

Purpose: Resolve UAT test #8 failure where users must click twice to scan - first click navigates but doesn't scan, second click actually starts scan. This creates confusing UX where "No Duplicates Found" appears before any scan runs.

Output: ScanView automatically triggers scan when navigated to, eliminating the two-click behavior.
</objective>

<execution_context>
@/Users/Moshe.Avni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Moshe.Avni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/Moshe.Avni/Repos/duplicate-photos-ios/.planning/PROJECT.md
@/Users/Moshe.Avni/Repos/duplicate-photos-ios/.planning/ROADMAP.md
@/Users/Moshe.Avni/Repos/duplicate-photos-ios/.planning/STATE.md
@/Users/Moshe.Avni/Repos/duplicate-photos-ios/.planning/debug/scan-button-first-click-issue.md
@/Users/Moshe.Avni/Repos/duplicate-photos-ios/DuplicatePhotos/Views/ContentView.swift
</context>

<tasks>

<task type="auto">
  <name>Add .task modifier to auto-start scan on ScanView appear</name>
  <files>DuplicatePhotos/Views/ContentView.swift</files>
  <action>
Add .task modifier to ScanView body to automatically trigger scan when view appears.

**Location:** ScanView struct (lines 56-94), add after .onChange modifier

**Implementation:**
```swift
.task {
    // Auto-start scan when view first appears
    if !viewModel.isScanning && viewModel.duplicateGroups.isEmpty {
        await viewModel.startScan()
    }
}
```

**Why conditional check:** Prevents re-scanning if user navigates back to a ScanView that already has results. Only scan if:
- Not currently scanning (avoid double-scan)
- No results yet (isEmpty check distinguishes "haven't scanned" from "scanned, found nothing")

**Gap closure:** This fixes the root cause identified in debug session - NavigationLink navigates but doesn't trigger scan. Now scan starts automatically on navigation.

**Alternative considered but rejected:** Converting NavigationLink to Button with programmatic navigation would require NavigationPath state management and complicate ContentView. The .task approach is simpler and follows SwiftUI best practices for view lifecycle actions.
  </action>
  <verify>
1. Build app successfully: `xcodebuild -project /Users/Moshe.Avni/Repos/duplicate-photos-ios/DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build`
2. Manual test in simulator:
   - Open app fresh
   - Click "Start Scan" button once
   - Should immediately see ScanProgressView (not EmptyScanView)
   - Scan should run without second click
  </verify>
  <done>
- .task modifier added to ScanView
- Conditional logic prevents double-scanning
- First click on "Start Scan" immediately shows scan progress
- Build succeeds with no errors
  </done>
</task>

</tasks>

<verification>
## UAT Test #8 Re-verification

After this fix, re-test the scenario:
1. Close and reopen app
2. Click "Start Scan" button (first click)
3. Expected: Immediate scan progress, no "No Duplicates Found" screen
4. Expected: Scan completes and shows results (or genuine empty state)
5. Expected: No second click required

## Edge Cases Verified

- Navigate to ScanView with existing results: Should NOT re-scan (isEmpty check prevents)
- Navigate back and forth: Should preserve results on back navigation
- Scan already running: Should NOT start second scan (isScanning check prevents)
</verification>

<success_criteria>
- [x] .task modifier added to ScanView
- [x] Scan auto-starts on first navigation (single click behavior)
- [x] EmptyScanView only shows after actual scan completes with zero results
- [x] No re-scanning when navigating to ScanView with existing results
- [x] Build succeeds
- [x] UAT test #8 passes on re-test
</success_criteria>

<output>
After completion, create `.planning/phases/71-settings-screen/71-02-SUMMARY.md`
</output>
