---
phase: 73-polish-and-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - DuplicatePhotosTests/SimilarityServiceTests.swift
autonomous: true

must_haves:
  truths:
    - "Cosine similarity tests pass for identical, orthogonal, opposite, and known-value vectors"
    - "Edge cases handled: zero vectors return 0.0, different-length vectors return 0.0"
    - "Grouping tests either pass with mock approach OR TODO comment documents PHAsset mocking limitation"
  artifacts:
    - path: "DuplicatePhotosTests/SimilarityServiceTests.swift"
      provides: "Unit tests for SimilarityService"
      min_lines: 80
  key_links:
    - from: "DuplicatePhotosTests/SimilarityServiceTests.swift"
      to: "DuplicatePhotos/Services/SimilarityService.swift"
      via: "@testable import"
      pattern: "@testable import DuplicatePhotos"
---

<objective>
Add unit tests for the core SimilarityService algorithms: cosine similarity computation and connected components grouping.

Purpose: Validate the mathematical correctness of the duplicate detection algorithms. These are the core algorithms that determine if photos are duplicates.

Output: SimilarityServiceTests.swift with comprehensive test coverage for both algorithms.
</objective>

<execution_context>
@/Users/Moshe.Avni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Moshe.Avni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DuplicatePhotos/Services/SimilarityService.swift
@.planning/phases/73-polish-and-testing/73-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SimilarityServiceTests with cosine similarity tests</name>
  <files>DuplicatePhotosTests/SimilarityServiceTests.swift</files>
  <action>
Create SimilarityServiceTests.swift with XCTest async support for testing the actor-based SimilarityService.

**Test cases for cosineSimilarity:**
1. `testCosineSimilarity_identicalVectors` - Same vector should return 1.0
2. `testCosineSimilarity_orthogonalVectors` - Perpendicular vectors [1,0,0] and [0,1,0] should return 0.0
3. `testCosineSimilarity_oppositeVectors` - Negated vector should return -1.0
4. `testCosineSimilarity_knownValue` - Vectors [1,0] and [1,1] should return 1/sqrt(2) (approx 0.7071)
5. `testCosineSimilarity_differentLengths` - Mismatched array lengths should return 0.0
6. `testCosineSimilarity_zeroVector` - Zero vector should return 0.0 (avoid division by zero)

**Implementation notes:**
- Use `let epsilon: Float = 0.0001` for float comparisons
- Use `XCTAssertEqual(result, expected, accuracy: epsilon)` for all float assertions
- Mark test methods as `async` to properly test the actor
- Use `await sut.cosineSimilarity(a, b)` pattern
- Create fresh SimilarityService instance in setUp()

**Test file structure:**
```swift
import XCTest
@testable import DuplicatePhotos

final class SimilarityServiceTests: XCTestCase {
    var sut: SimilarityService!
    let epsilon: Float = 0.0001

    override func setUp() {
        super.setUp()
        sut = SimilarityService()
    }

    // Cosine similarity tests here...
}
```
  </action>
  <verify>Run `xcodebuild test -project DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 16' -only-testing:DuplicatePhotosTests/SimilarityServiceTests 2>&1 | grep -E "(Test Case|passed|failed)"` - all 6 cosine similarity tests pass</verify>
  <done>6 cosine similarity test cases pass: identical (1.0), orthogonal (0.0), opposite (-1.0), known value (0.7071), different lengths (0.0), zero vector (0.0)</done>
</task>

<task type="auto">
  <name>Task 2: Add connected components grouping tests</name>
  <files>DuplicatePhotosTests/SimilarityServiceTests.swift</files>
  <action>
Add test cases for the `groupSimilarPhotos` method to the existing SimilarityServiceTests.swift.

**Challenge:** PhotoAsset requires PHAsset which cannot be instantiated in tests. Create a test helper approach:

**Option A (Recommended):** Test only `cosineSimilarity` directly, document that `groupSimilarPhotos` needs PhotoAsset mocking which requires protocol extraction (future refactor).

**Option B:** If simple mock approach is available, add these tests:
1. `testGroupSimilarPhotos_emptyInput` - Empty pairs returns empty groups
2. `testGroupSimilarPhotos_singlePair` - One pair creates one group with 2 photos
3. `testGroupSimilarPhotos_transitiveChain` - A-B, B-C creates one group with 3 photos
4. `testGroupSimilarPhotos_disjointPairs` - A-B and C-D creates two groups

**Note on current implementation:** The `groupSimilarPhotos` method has a known issue - it returns groups with empty photos arrays (`DuplicateGroup(photos: [], ...)`). This is because the method only receives pairs, not the full photo array. The tests should document this current behavior.

If PHAsset mocking proves impossible, add a TODO comment explaining the limitation and skip these tests for now. Focus on the cosine similarity tests which are the critical mathematical correctness tests.
  </action>
  <verify>Run tests again to ensure all tests still pass. If grouping tests were added, verify they pass. If skipped, verify comment explains why.</verify>
  <done>Either: (a) grouping tests pass with mock approach, or (b) clear TODO comment documents PHAsset mocking limitation and suggests protocol extraction for future testability</done>
</task>

</tasks>

<verification>
1. `xcodebuild test -project DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 16' -only-testing:DuplicatePhotosTests 2>&1 | tail -20` shows tests passing
2. Cosine similarity tests cover all mathematical edge cases
3. Test file imports and compiles without errors
</verification>

<success_criteria>
- [ ] SimilarityServiceTests.swift exists in DuplicatePhotosTests/
- [ ] At least 6 async test cases for cosineSimilarity
- [ ] All tests pass when run via xcodebuild
- [ ] Float comparisons use accuracy parameter (not ==)
- [ ] Grouping tests either: pass with mocks OR have documented limitation
</success_criteria>

<output>
After completion, create `.planning/phases/73-polish-and-testing/73-01-SUMMARY.md`
</output>
