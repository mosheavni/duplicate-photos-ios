---
phase: 73-polish-and-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - DuplicatePhotos/Views/ContentView.swift
autonomous: true

must_haves:
  truths:
    - "Empty scan result shows ContentUnavailableView with checkmark icon and clean message"
    - "Permission denied shows ContentUnavailableView with settings link"
    - "Permission restricted shows explanation about parental controls"
    - "User can tap 'Open Settings' to go to app settings when permission denied"
  artifacts:
    - path: "DuplicatePhotos/Views/ContentView.swift"
      provides: "Enhanced empty state and permission handling views"
      contains: "ContentUnavailableView"
  key_links:
    - from: "DuplicatePhotos/Views/ContentView.swift"
      to: "UIApplication.openSettingsURLString"
      via: "Settings deep link"
      pattern: "openSettingsURLString"
---

<objective>
Enhance empty state UI with ContentUnavailableView and add proper permission denied/restricted handling.

Purpose: Provide clear, native-looking feedback when no duplicates are found or when photo library access is denied. Uses standard iOS 17 patterns for consistency with system apps.

Output: Updated ContentView.swift with ContentUnavailableView for empty states and permission error states.
</objective>

<execution_context>
@/Users/Moshe.Avni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Moshe.Avni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@DuplicatePhotos/Views/ContentView.swift
@DuplicatePhotos/Services/PhotoLibraryService.swift
@DuplicatePhotos/ViewModels/ScanViewModel.swift
@.planning/phases/73-polish-and-testing/73-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace EmptyScanView with ContentUnavailableView</name>
  <files>DuplicatePhotos/Views/ContentView.swift</files>
  <action>
Update the EmptyScanView struct to use iOS 17's ContentUnavailableView for a native, consistent look.

**Replace current EmptyScanView implementation with:**

```swift
struct EmptyScanView: View {
    @ObservedObject var viewModel: ScanViewModel

    var body: some View {
        ContentUnavailableView {
            Label("No Duplicates Found", systemImage: "checkmark.circle")
        } description: {
            Text("Your photo library looks clean! All your photos appear to be unique.")
        } actions: {
            Button {
                Task {
                    await viewModel.startScan()
                }
            } label: {
                Text("Scan Again")
            }
            .buttonStyle(.borderedProminent)
        }
        .navigationTitle("Scan Results")
    }
}
```

**Key changes:**
- Remove custom VStack layout, Spacer, gradients
- Remove diagnostic info section (was for debugging, not needed for polish)
- Use ContentUnavailableView's standard layout
- Keep the "Scan Again" action but use .buttonStyle(.borderedProminent)
- Maintain navigationTitle for consistency
  </action>
  <verify>Build succeeds: `xcodebuild build -project DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 16' 2>&1 | grep -E "(BUILD|error:)"` shows BUILD SUCCEEDED</verify>
  <done>EmptyScanView uses ContentUnavailableView with checkmark.circle icon, description text, and Scan Again button</done>
</task>

<task type="auto">
  <name>Task 2: Add permission error state handling</name>
  <files>DuplicatePhotos/Views/ContentView.swift</files>
  <action>
Add permission state handling to ScanView to show appropriate UI when photo library access is denied or restricted.

**1. Add a PermissionDeniedView struct:**

```swift
struct PermissionDeniedView: View {
    var body: some View {
        ContentUnavailableView {
            Label("Photo Access Required", systemImage: "photo.badge.exclamationmark")
        } description: {
            Text("Please allow access to your photos in Settings to scan for duplicates.")
        } actions: {
            Button("Open Settings") {
                if let url = URL(string: UIApplication.openSettingsURLString) {
                    UIApplication.shared.open(url)
                }
            }
            .buttonStyle(.borderedProminent)
        }
        .navigationTitle("Permission Required")
    }
}
```

**2. Add a PermissionRestrictedView struct:**

```swift
struct PermissionRestrictedView: View {
    var body: some View {
        ContentUnavailableView {
            Label("Access Restricted", systemImage: "lock.shield")
        } description: {
            Text("Photo library access is restricted by parental controls or device management. Contact your administrator.")
        }
        .navigationTitle("Access Restricted")
    }
}
```

**3. Update ScanViewModel to track permission state:**

Add to ScanViewModel (in the same file or separate - keep in same file for simplicity):
- Add `@Published var permissionState: PermissionState = .notDetermined`
- Add enum `PermissionState { case notDetermined, authorized, limited, denied, restricted }`
- In `startScan()`, catch the PhotoLibraryError cases and set appropriate state

**4. Update ScanView to handle permission states:**

In ScanView's body, add conditions for permission states:
```swift
if viewModel.permissionState == .denied {
    PermissionDeniedView()
} else if viewModel.permissionState == .restricted {
    PermissionRestrictedView()
} else if viewModel.isScanning {
    // existing scanning view
} else if !viewModel.duplicateGroups.isEmpty {
    // existing results view
} else {
    EmptyScanView(viewModel: viewModel)
}
```

**Implementation notes:**
- Import UIKit only if not already imported (for UIApplication)
- The permission state should be set when startScan fails with accessDenied or accessRestricted
- For .notDetermined, proceed with scan (will prompt user)
- For .authorized and .limited, proceed normally
  </action>
  <verify>Build succeeds. Run app in simulator, deny photo permission, verify PermissionDeniedView appears with working "Open Settings" button</verify>
  <done>Permission denied shows ContentUnavailableView with "Open Settings" button that works. Permission restricted shows explanation. Normal flow unchanged.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild build -project DuplicatePhotos.xcodeproj -scheme DuplicatePhotos -destination 'platform=iOS Simulator,name=iPhone 16'`
2. Run app, complete scan with no duplicates -> ContentUnavailableView with checkmark appears
3. Reset simulator privacy settings, run app, deny permission -> PermissionDeniedView appears
4. "Open Settings" button opens iOS Settings
</verification>

<success_criteria>
- [ ] EmptyScanView uses ContentUnavailableView (not custom VStack layout)
- [ ] PermissionDeniedView exists with "Open Settings" button
- [ ] PermissionRestrictedView exists with parental controls explanation
- [ ] ScanView conditionally shows appropriate view based on permission state
- [ ] All views have appropriate navigationTitle
- [ ] Build succeeds without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/73-polish-and-testing/73-02-SUMMARY.md`
</output>
