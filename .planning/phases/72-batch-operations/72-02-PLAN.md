---
phase: 72-batch-operations
plan: 02
type: execute
wave: 2
depends_on: ["72-01"]
files_modified:
  - DuplicatePhotos/Views/GroupDetailView.swift
  - DuplicatePhotos/Views/DuplicateGroupsListView.swift
  - DuplicatePhotos/Views/ContentView.swift
  - DuplicatePhotos.xcodeproj/project.pbxproj
autonomous: false

must_haves:
  truths:
    - "User can delete all duplicates in a group with one tap"
    - "User can deselect photos to keep specific instances"
    - "User can bulk-delete all duplicates across all groups"
    - "User sees confirmation dialog for bulk delete (photo count)"
    - "User sees toast feedback after deletion"
    - "UI updates immediately after deletion"
  artifacts:
    - path: "DuplicatePhotos/Views/GroupDetailView.swift"
      provides: "Auto-select best, immediate delete, toast feedback"
      contains: "AlertToast"
    - path: "DuplicatePhotos/Views/DuplicateGroupsListView.swift"
      provides: "Bulk delete all button with confirmation"
      contains: "Delete All Duplicates"
    - path: "DuplicatePhotos/Views/ContentView.swift"
      provides: "ScanViewModel binding for group removal"
      contains: "viewModel"
  key_links:
    - from: "GroupDetailView"
      to: "DuplicateGroup.photosToDeleteIds"
      via: "auto-selection on appear"
      pattern: "selectedPhotos.*photosToDeleteIds"
    - from: "DuplicateGroupsListView"
      to: "ScanViewModel.removeGroup"
      via: "callback after deletion"
      pattern: "removeGroup"
---

<objective>
Implement batch deletion UI with auto-selection, bulk delete, toast feedback, and immediate UI updates.

Purpose: Enable users to efficiently delete duplicates with minimal friction - single tap for per-group deletion, confirmation for bulk operations, and clear feedback.

Output: Complete batch deletion experience matching CONTEXT.md decisions.
</objective>

<execution_context>
@/Users/Moshe.Avni/.claude/get-shit-done/workflows/execute-plan.md
@/Users/Moshe.Avni/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/72-batch-operations/72-CONTEXT.md
@.planning/phases/72-batch-operations/72-RESEARCH.md
@.planning/phases/72-batch-operations/72-01-SUMMARY.md
@DuplicatePhotos/Views/GroupDetailView.swift
@DuplicatePhotos/Views/DuplicateGroupsListView.swift
@DuplicatePhotos/Views/ContentView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AlertToast package dependency</name>
  <files>DuplicatePhotos.xcodeproj/project.pbxproj</files>
  <action>
Add AlertToast Swift Package to the project for toast notifications.

Use Xcode CLI or manual steps:
1. In Xcode, go to File > Add Package Dependencies
2. Enter URL: https://github.com/elai950/AlertToast
3. Select version: Up to Next Major (from 1.3.9)
4. Add to DuplicatePhotos target

Alternatively, if project.pbxproj can be edited directly, add the package reference.

After adding, verify by importing in a test file:
```swift
import AlertToast
```

The package provides `.toast()` view modifier for non-blocking feedback.
  </action>
  <verify>Build project with Cmd+B - AlertToast import should work without errors.</verify>
  <done>AlertToast package is added to the project and can be imported.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance GroupDetailView with auto-select and toast</name>
  <files>DuplicatePhotos/Views/GroupDetailView.swift</files>
  <action>
Update GroupDetailView to:

1. **Auto-select photos to delete on appear** using group.photosToDeleteIds
2. **Show best photo indicator** with a star badge
3. **Remove confirmation for single-group delete** (per CONTEXT.md - iOS Recently Deleted is safety net)
4. **Add toast feedback** after deletion
5. **Accept callback to notify parent** when group should be removed

Changes:

```swift
import AlertToast

struct GroupDetailView: View {
    let group: DuplicateGroup
    var onGroupDeleted: ((UUID) -> Void)?  // Callback to parent

    @State private var selectedPhotos: Set<String> = []
    @State private var isDeleting = false
    @State private var showToast = false
    @State private var toastMessage = ""
    @State private var toastType: AlertToast.AlertType = .complete(.green)
    @Environment(\.dismiss) private var dismiss

    var body: some View {
        ScrollView {
            // ... existing VStack content
        }
        .onAppear {
            // Auto-select duplicates (all except best)
            selectedPhotos = group.photosToDeleteIds
        }
        .toast(isPresenting: $showToast, duration: 2.0) {
            AlertToast(displayMode: .banner(.pop), type: toastType, title: toastMessage)
        }
        // Remove .confirmationDialog - delete immediately per CONTEXT.md
    }

    private func deleteSelectedPhotos() async {
        isDeleting = true
        let photosToDelete = group.photos.filter { selectedPhotos.contains($0.id) }
        let assets = photosToDelete.map { $0.phAsset }
        let deleteCount = assets.count

        do {
            try await PHPhotoLibrary.shared().performChanges {
                PHAssetChangeRequest.deleteAssets(assets as NSArray)
            }

            await MainActor.run {
                toastMessage = "Deleted \(deleteCount) photo\(deleteCount == 1 ? "" : "s")"
                toastType = .complete(.green)
                showToast = true
            }

            // Notify parent to remove group if all duplicates deleted
            if selectedPhotos.count == group.photosToDelete.count {
                await MainActor.run {
                    onGroupDeleted?(group.id)
                    dismiss()
                }
            } else {
                await MainActor.run {
                    selectedPhotos.removeAll()
                }
            }
        } catch {
            await MainActor.run {
                toastMessage = "Delete failed: \(error.localizedDescription)"
                toastType = .error(.red)
                showToast = true
            }
        }

        isDeleting = false
    }
}
```

In PhotoThumbnailView, add star indicator for best photo:
```swift
// Add isBest parameter
let isBest: Bool

// In ZStack, add star badge:
if isBest {
    Image(systemName: "star.fill")
        .font(.caption)
        .foregroundStyle(.yellow)
        .padding(6)
        .background(.ultraThinMaterial)
        .clipShape(Circle())
        .offset(x: -4, y: 4)
}
```

Update the ForEach to pass isBest:
```swift
PhotoThumbnailView(
    photo: photo,
    isSelected: selectedPhotos.contains(photo.id),
    isBest: photo.id == group.bestPhoto?.id
) { ... }
```

Update the delete button to call deleteSelectedPhotos directly (no confirmation):
```swift
Button(role: .destructive) {
    Task {
        await deleteSelectedPhotos()
    }
} label: {
    Label("Delete \(selectedPhotos.count) Selected", systemImage: "trash")
        .frame(maxWidth: .infinity)
}
.buttonStyle(.borderedProminent)
.disabled(isDeleting || selectedPhotos.isEmpty)
```

Update "Keep Best, Delete Others" button text to be clearer and include toast message:
```swift
Button {
    selectedPhotos = group.photosToDeleteIds
    // Optionally auto-delete immediately:
    // Task { await deleteSelectedPhotos() }
} label: {
    Label("Select Duplicates", systemImage: "checkmark.circle")
        .frame(maxWidth: .infinity)
}
```
  </action>
  <verify>Build with Cmd+B. Run in simulator, navigate to a duplicate group. Verify: 1) duplicates are auto-selected on appear, 2) best photo has star badge, 3) delete button works without confirmation dialog, 4) toast appears after deletion.</verify>
  <done>GroupDetailView auto-selects duplicates, shows best photo indicator, deletes without confirmation, shows toast feedback.</done>
</task>

<task type="auto">
  <name>Task 3: Add bulk delete to DuplicateGroupsListView and wire up callbacks</name>
  <files>
    DuplicatePhotos/Views/DuplicateGroupsListView.swift
    DuplicatePhotos/Views/ContentView.swift
  </files>
  <action>
**DuplicateGroupsListView changes:**

1. Accept viewModel binding for state updates
2. Add "Delete All Duplicates" button in toolbar
3. Show confirmation dialog with total count for bulk delete
4. Add toast feedback

```swift
import AlertToast
import Photos

struct DuplicateGroupsListView: View {
    @ObservedObject var viewModel: ScanViewModel

    @State private var showBulkDeleteConfirmation = false
    @State private var isDeleting = false
    @State private var showToast = false
    @State private var toastMessage = ""
    @State private var toastType: AlertToast.AlertType = .complete(.green)

    var body: some View {
        ScrollView {
            LazyVStack(spacing: 16) {
                ForEach(viewModel.duplicateGroups) { group in
                    NavigationLink(destination: GroupDetailView(
                        group: group,
                        onGroupDeleted: { groupId in
                            viewModel.removeGroup(id: groupId)
                        }
                    )) {
                        GroupCardView(group: group)
                    }
                    .buttonStyle(.plain)
                }
            }
            .padding()
        }
        .navigationTitle("Duplicate Groups")
        .navigationBarTitleDisplayMode(.large)
        .toolbar {
            ToolbarItem(placement: .topBarTrailing) {
                if !viewModel.duplicateGroups.isEmpty {
                    Button(role: .destructive) {
                        showBulkDeleteConfirmation = true
                    } label: {
                        Label("Delete All", systemImage: "trash")
                    }
                    .disabled(isDeleting)
                }
            }
        }
        .confirmationDialog(
            "Delete \(viewModel.totalPhotosToDelete) photos?",
            isPresented: $showBulkDeleteConfirmation,
            titleVisibility: .visible
        ) {
            Button("Delete \(viewModel.totalPhotosToDelete) Photos", role: .destructive) {
                Task {
                    await deleteAllDuplicates()
                }
            }
            Button("Cancel", role: .cancel) {}
        } message: {
            Text("Photos will be moved to Recently Deleted for 30 days.")
        }
        .toast(isPresenting: $showToast, duration: 2.5) {
            AlertToast(displayMode: .banner(.pop), type: toastType, title: toastMessage)
        }
    }

    private func deleteAllDuplicates() async {
        isDeleting = true
        var totalDeleted = 0
        var errors: [Error] = []

        // Delete group by group for partial failure handling
        for group in viewModel.duplicateGroups {
            let assets = group.photosToDelete.map { $0.phAsset }
            do {
                try await PHPhotoLibrary.shared().performChanges {
                    PHAssetChangeRequest.deleteAssets(assets as NSArray)
                }
                totalDeleted += assets.count
            } catch {
                errors.append(error)
            }
        }

        await MainActor.run {
            // Clear all groups since we deleted from all of them
            viewModel.duplicateGroups = []

            if errors.isEmpty {
                toastMessage = "Deleted \(totalDeleted) photos"
                toastType = .complete(.green)
            } else {
                toastMessage = "Deleted \(totalDeleted) photos, \(errors.count) groups failed"
                toastType = .error(.orange)
            }
            showToast = true
            isDeleting = false
        }
    }
}
```

**ContentView changes:**

Update ScanView to pass viewModel to DuplicateGroupsListView:

```swift
} else if !viewModel.duplicateGroups.isEmpty {
    DuplicateGroupsListView(viewModel: viewModel)
        .toolbar {
            ToolbarItem(placement: .topBarTrailing) {
                Button {
                    Task {
                        await viewModel.startScan()
                    }
                } label: {
                    Label("Rescan", systemImage: "arrow.clockwise")
                }
            }
        }
}
```

Note: The toolbar for "Rescan" should now be on DuplicateGroupsListView, not duplicated. Move it there if needed, or keep both (one for bulk delete, one for rescan).
  </action>
  <verify>Build with Cmd+B. Run in simulator with duplicates. Test: 1) "Delete All" button appears in toolbar when groups exist, 2) tapping shows confirmation with total count, 3) confirming deletes all duplicates, 4) toast shows success, 5) groups list becomes empty.</verify>
  <done>DuplicateGroupsListView has bulk delete with confirmation dialog and toast. GroupDetailView callbacks wire up to ScanViewModel for state updates.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete batch deletion flow with auto-selection, single-tap delete, bulk delete all with confirmation, and toast feedback</what-built>
  <how-to-verify>
1. Build and run the app in iOS Simulator (Cmd+R)
2. Start a scan - ensure you have duplicate photos in the library
3. When results appear, verify:
   - "Delete All" button appears in toolbar
   - Tap a duplicate group to enter detail view

4. In GroupDetailView, verify:
   - Duplicates are auto-selected (checkmarks on all except one)
   - Best photo has a star indicator
   - Delete button shows correct count
   - Tapping delete works WITHOUT showing confirmation dialog
   - Toast appears: "Deleted X photos"
   - View dismisses or updates after deletion

5. Go back to groups list, tap "Delete All", verify:
   - Confirmation dialog shows: "Delete X photos?"
   - Message mentions "Recently Deleted for 30 days"
   - Confirming deletes all duplicates
   - Toast shows success message
   - Groups list is now empty (or shows "No Duplicates Found")

6. Test deselection: Enter a group, tap a selected photo to deselect, verify:
   - Photo is deselected (checkmark removed)
   - Delete button count updates
   - Can keep both/all instances by deselecting all
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Functional verification via human testing (Task 4 checkpoint):
1. Auto-selection works on group detail appear
2. Best photo has star indicator
3. Single-group delete works without confirmation
4. Bulk delete shows confirmation with photo count
5. Toast feedback appears after deletion
6. UI updates immediately (group removed from list)
7. User can deselect to keep specific photos
</verification>

<success_criteria>
- [ ] AlertToast package added and working
- [ ] GroupDetailView auto-selects duplicates on appear
- [ ] Best photo indicator (star badge) visible
- [ ] Single-group delete works without confirmation
- [ ] Bulk "Delete All" button in toolbar with confirmation
- [ ] Toast feedback after deletion
- [ ] Groups removed from list after deletion
- [ ] Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/72-batch-operations/72-02-SUMMARY.md`
</output>
